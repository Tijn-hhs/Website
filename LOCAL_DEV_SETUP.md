# Local Development Setup - Amplify Auth Configuration

## Quick Start

To run the app locally with authentication working:

### Option 1: Using Amplify Sandbox (Recommended)

```bash
# Start Amplify sandbox (generates amplify_outputs.json automatically)
npm run sandbox

# In another terminal, start the dev server
npm run dev
```

The sandbox deploys your Amplify backend locally and generates `public/amplify_outputs.json` with full Cognito configuration.

### Option 2: Generate Outputs Without Sandbox

```bash
# Generate amplify_outputs.json from your connected Amplify backend
npm run amplify:outputs

# Then start dev server
npm run dev
```

## What's Happening

The app fetches configuration from `/amplify_outputs.json` at runtime. This file contains:
- **Cognito UserPool ID** and **Client ID** for authentication
- **Custom API endpoint** and region for backend calls
- **Storage buckets, Analytics, and other service configs**

## Local Development Flow

1. **First Setup**: Run `npm run sandbox` to initialize Amplify resources locally
2. **Daily Development**: 
   - Keep `npm run sandbox` running in one terminal (or restart as needed)
   - Run `npm run dev` in another terminal
   - Visit `http://localhost:5173`

## Verifying Configuration

Check that authentication is configured locally:

1. Open browser DevTools Console
2. Visit `http://localhost:5173/amplify_outputs.json`
3. Verify the JSON contains:
   ```json
   {
     "auth": {
       "userPoolId": "us-east-1_xxxxx",
       "userPoolClientId": "xxxxx",
       ...
     },
     ...
   }
   ```

If you only see `{"version": "1.4"}`, run `npm run sandbox` to generate full configuration.

## Troubleshooting

### "Auth UserPool not configured" Error

This appears when `amplify_outputs.json` lacks Cognito credentials.

**Fix**:
```bash
# Regenerate configuration from Amplify backend
npm run amplify:outputs

# Or use sandbox for full local development
npm run sandbox
```

### "Failed to fetch configuration" Error

The app cannot find `/amplify_outputs.json` in the public folder.

**Fix**:
1. Ensure `npm run amplify:outputs` completes successfully
2. Check that `public/amplify_outputs.json` exists
3. Restart dev server: `npm run dev`

### Configuration Changes Not Reflected

After running `amplify:outputs`, you may need to:
1. Restart the dev server: `npm run dev`
2. Clear browser cache (Vite may cache the JSON)
3. Hard refresh: `Cmd+Shift+R` (Mac) or `Ctrl+Shift+R` (Windows)

## Files

- **`amplify/backend.ts`** - Backend infrastructure definition (Cognito auth, API, database)
- **`amplify/auth/resource.ts`** - Cognito/auth-specific configuration  
- **`public/amplify_outputs.json`** - Generated runtime config (generated, NOT in version control)
- **`src/main.tsx`** - Fetches and initializes Amplify with this config
- **`.gitignore`** - Excludes environment-specific `amplify_outputs.json` from git

## Production vs. Local

| Aspect | Local (Sandbox) | Production |
|--------|-----------------|------------|
| Backend | Local AWS mock with Amplify sandbox | AWS cloud services |
| Config source | Generated by `npm run sandbox` | Deployed with your backend |
| Storage | Local/in-memory | AWS S3 |
| Database | Local DynamoDB | AWS DynamoDB |
| Auth | Local Cognito sandbox | AWS Cognito |

Both use the same `amplify_outputs.json` format; only the service endpoints differ.

## Need Help?

- Check browser console for detailed error messages
- Verify `npm run sandbox` is running without errors
- Ensure `public/amplify_outputs.json` was created and contains auth config
- Review AWS Amplify documentation: https://docs.amplify.aws/
